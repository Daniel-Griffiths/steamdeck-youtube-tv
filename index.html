<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Youtube</title>
    <meta
      http-equiv="Content-Security-Policy"
      content="script-src 'self' 'unsafe-inline';"
    />
  </head>
  <body>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
    </style>
    <webview
      id="webview"
      tabindex="0"
      src="https://www.youtube.com/tv?env_forceFullAnimation=true"
      httpreferrer="https://www.youtube.com/tv"
      style="height: 100vh; width: 100vw; background: #000"
      useragent="Mozilla/5.0 (Linux; Android 12) Cobalt/22.2.3-gold (PS4)"
    ></webview>
    <script>
      const { GamepadListener } = require("gamepad.js");

      const webview = document.getElementById("webview");

      document.addEventListener("DOMContentLoaded", function () {
        webview.focus();
      });

      const GAMEPAD_BUTTON = {
        CROSS: 0,
        CIRCLE: 1,
        SQUARE: 2,
        TRIANGLE: 3,
        DPAD_UP: 12,
        DPAD_DOWN: 13,
        DPAD_LEFT: 14,
        DPAD_RIGHT: 15,
      };

      const buttonMap = {
        [GAMEPAD_BUTTON.CROSS]: String.fromCharCode(0x0d),
        [GAMEPAD_BUTTON.CIRCLE]: "Escape",
        [GAMEPAD_BUTTON.DPAD_UP]: "Up",
        [GAMEPAD_BUTTON.DPAD_DOWN]: "Down",
        [GAMEPAD_BUTTON.DPAD_LEFT]: "Left",
        [GAMEPAD_BUTTON.DPAD_RIGHT]: "Right",
      };

      const REPEAT_DELAY = 400;
      const REPEAT_INTERVAL = 100;

      const repeatableButtons = new Set([
        GAMEPAD_BUTTON.DPAD_UP,
        GAMEPAD_BUTTON.DPAD_DOWN,
        GAMEPAD_BUTTON.DPAD_LEFT,
        GAMEPAD_BUTTON.DPAD_RIGHT,
      ]);

      const heldButtons = new Map();

      function sendKey(keyCode, type) {
        webview.sendInputEvent({ type, keyCode });
      }

      function startKeyRepeat(button, keyCode) {
        stopKeyRepeat(button);
        sendKey(keyCode, "keyDown");

        const delayTimer = setTimeout(() => {
          const repeatTimer = setInterval(() => {
            sendKey(keyCode, "keyUp");
            sendKey(keyCode, "keyDown");
          }, REPEAT_INTERVAL);

          heldButtons.set(button, { repeatTimer, keyCode });
        }, REPEAT_DELAY);

        heldButtons.set(button, { delayTimer, keyCode });
      }

      function stopKeyRepeat(button) {
        const held = heldButtons.get(button);
        if (held) {
          clearTimeout(held.delayTimer);
          clearInterval(held.repeatTimer);
          sendKey(held.keyCode, "keyUp");
          heldButtons.delete(button);
        }
      }

      const listener = new GamepadListener();
      let activeGamepad = null;

      listener.on("gamepad:button", (event) => {
        const { gamepad, button, pressed } = event.detail;

        if (activeGamepad === null && pressed) {
          activeGamepad = gamepad.index;
        }

        if (gamepad.index !== activeGamepad) return;

        const keyCode = buttonMap[button];
        if (!keyCode) return;

        if (repeatableButtons.has(button)) {
          if (pressed) {
            startKeyRepeat(button, keyCode);
          } else {
            stopKeyRepeat(button);
          }
        } else {
          sendKey(keyCode, pressed ? "keyDown" : "keyUp");
        }
      });

      listener.on("gamepad:disconnected", (event) => {
        if (event.detail.index === activeGamepad) {
          activeGamepad = null;
          heldButtons.forEach((_, button) => stopKeyRepeat(button));
        }
      });

      listener.start();
    </script>
  </body>
</html>
