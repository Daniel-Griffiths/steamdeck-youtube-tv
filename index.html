<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Youtube</title>
    <meta
      http-equiv="Content-Security-Policy"
      content="script-src 'self' 'unsafe-inline';"
    />
  </head>
  <body>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
    </style>
    <webview
      id="webview"
      tabindex="0"
      src="https://www.youtube.com/tv?env_forceFullAnimation=true"
      httpreferrer="https://www.youtube.com/tv"
      style="height: 100vh; width: 100vw; background: #000"
      useragent="Mozilla/5.0 (Linux; Android 12) Cobalt/22.2.3-gold (PS4)"
    ></webview>
    <script>
      const { GamepadListener } = require("gamepad.js");

      const webview = document.getElementById("webview");

      document.addEventListener("DOMContentLoaded", function () {
        webview.focus();
      });

      // Button to key mapping
      // Standard gamepad: 0=Cross/A, 1=Circle/B, 2=Square/X, 3=Triangle/Y
      // 12=Up, 13=Down, 14=Left, 15=Right
      const buttonMap = {
        0: String.fromCharCode(0x0d), // Cross/A - Enter (carriage return)
        1: "Escape", // Circle/B - Back
        12: "Up", // D-pad Up
        13: "Down", // D-pad Down
        14: "Left", // D-pad Left
        15: "Right", // D-pad Right
      };

      // Key repeat settings (in ms)
      const REPEAT_DELAY = 400; // Initial delay before repeating
      const REPEAT_INTERVAL = 100; // Interval between repeats

      // Track held buttons and their repeat timers
      const heldButtons = new Map();

      function sendKey(keyCode, type) {
        webview.sendInputEvent({ type, keyCode });
      }

      function startKeyRepeat(button, keyCode) {
        stopKeyRepeat(button);
        sendKey(keyCode, "keyDown");

        const delayTimer = setTimeout(() => {
          const repeatTimer = setInterval(() => {
            sendKey(keyCode, "keyUp");
            sendKey(keyCode, "keyDown");
          }, REPEAT_INTERVAL);

          heldButtons.set(button, { repeatTimer, keyCode });
        }, REPEAT_DELAY);

        heldButtons.set(button, { delayTimer, keyCode });
      }

      function stopKeyRepeat(button) {
        const held = heldButtons.get(button);
        if (held) {
          clearTimeout(held.delayTimer);
          clearInterval(held.repeatTimer);
          sendKey(held.keyCode, "keyUp");
          heldButtons.delete(button);
        }
      }

      const listener = new GamepadListener();

      // Track the first gamepad that sends input (ignore others to prevent duplicates)
      let activeGamepad = null;

      listener.on("gamepad:button", (event) => {
        const { gamepad, button, pressed } = event.detail;

        if (activeGamepad === null && pressed) {
          activeGamepad = gamepad.index;
          console.log(
            `[Gamepad] Using gamepad ${gamepad.index}: ${gamepad.id}`
          );
        }

        if (gamepad.index !== activeGamepad) return;

        const keyCode = buttonMap[button];
        if (!keyCode) return;

        if (pressed) {
          startKeyRepeat(button, keyCode);
        } else {
          stopKeyRepeat(button);
        }
      });

      listener.on("gamepad:disconnected", (event) => {
        if (event.detail.index === activeGamepad) {
          console.log(`[Gamepad] Gamepad ${activeGamepad} disconnected`);
          activeGamepad = null;
          // Clear all held buttons
          heldButtons.forEach((_, button) => stopKeyRepeat(button));
        }
      });

      listener.start();
    </script>
  </body>
</html>
